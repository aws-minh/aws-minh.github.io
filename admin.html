<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #5AC8FA;
            --dark: #121212;
            --light: #F5F5F7;
            --gray: #86868b;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            letter-spacing: -0.015em;
            padding-top: 70px;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.03em;
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .card .card-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
            font-size: 1.25rem;
        }
        
        .stat-card {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .navbar {
            background-color: rgba(245, 245, 247, 0.8) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .table {
            font-size: 0.9rem;
        }
        
        .table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            color: var(--gray);
            border-top: none;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        
        #admin-content {
            display: none;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 400px;
            background-color: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .location-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .nav-tabs .nav-link {
            color: var(--gray);
            border: none;
            padding: 0.75rem 1rem;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            background-color: transparent;
            border-bottom: 2px solid var(--primary);
        }
        
        .nav-tabs {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .badge-count {
            background-color: var(--primary);
            color: white;
            border-radius: 12px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .world-map-svg {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }
        
        .country {
            fill: #e0e0e0;
            stroke: #fff;
            stroke-width: 0.5;
            transition: fill 0.3s ease;
        }
        
        .country:hover {
            fill: #bcd8ff;
            cursor: pointer;
        }
        
        .country.has-visitors {
            fill: #bcd8ff;
        }
        
        .country.selected {
            fill: var(--primary) !important;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Location cards */
        .location-card {
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            background-color: white;
            transition: transform 0.2s;
            border-left: 4px solid var(--primary);
        }
        
        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .location-name {
            font-weight: 600;
            margin-bottom: 0;
        }
        
        .location-meta {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .location-count {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">Minh Duc Nguyen</a>
            <span class="ms-auto">Admin Dashboard</span>
        </div>
    </nav>
    
    <div class="container">
        <!-- Login Form -->
        <div id="login-form" class="login-container card">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">Admin Login</h2>
                <form id="admin-login-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>
                <p id="login-error" class="text-danger mt-3 text-center" style="display: none;">Invalid credentials. Please try again.</p>
            </div>
        </div>
        
        <!-- Admin Dashboard Content -->
        <div id="admin-content">
            <div class="row mt-4">
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="total-views">--</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="today-views">--</div>
                            <div class="stat-label">Today's Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="weekly-views">--</div>
                            <div class="stat-label">Weekly Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="unique-visitors">--</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Daily Views</h2>
                            <div class="chart-container">
                                <canvas id="viewsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Section Popularity</h2>
                            <div class="chart-container">
                                <canvas id="sectionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Recent Visitor Activity</h2>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>Section</th>
                                            <th>Screen Size</th>
                                            <th>Browser</th>
                                        </tr>
                                    </thead>
                                    <tbody id="visitor-table">
                                        <!-- Table rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Location Analytics Section (Replacing External Analytics Dashboard) -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Global Visitor Analytics</h2>
                            
                            <!-- Location stats overview -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="stat-card p-3 border rounded">
                                        <div class="stat-value" id="total-countries">--</div>
                                        <div class="stat-label">Countries</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card p-3 border rounded">
                                        <div class="stat-value" id="total-cities">--</div>
                                        <div class="stat-label">Cities</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card p-3 border rounded">
                                        <div class="stat-value" id="top-country">--</div>
                                        <div class="stat-label">Top Country</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card p-3 border rounded">
                                        <div class="stat-value" id="top-city">--</div>
                                        <div class="stat-label">Top City</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Map Visualization -->
                            <div class="map-container mb-4" id="world-map">
                                <!-- SVG Map will be inserted here by JavaScript -->
                            </div>
                            
                            <!-- Location Tables Tabs -->
                            <ul class="nav nav-tabs" id="locationTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="countries-tab" data-bs-toggle="tab" data-bs-target="#countries" type="button" role="tab">
                                        Countries <span class="badge-count ms-2" id="countries-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="cities-tab" data-bs-toggle="tab" data-bs-target="#cities" type="button" role="tab">
                                        Cities <span class="badge-count ms-2" id="cities-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item ms-auto" role="presentation">
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-sm" id="location-search" placeholder="Search locations...">
                                        <button class="btn btn-sm btn-outline-secondary" type="button">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="locationTabContent">
                                <!-- Countries Tab -->
                                <div class="tab-pane fade show active" id="countries" role="tabpanel">
                                    <div class="table-responsive location-table-container mt-3">
                                        <table class="table" id="countries-table">
                                            <thead>
                                                <tr>
                                                    <th>Country</th>
                                                    <th>Visitors</th>
                                                    <th>% of Total</th>
                                                    <th>First Visit</th>
                                                    <th>Last Visit</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Country data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Cities Tab -->
                                <div class="tab-pane fade" id="cities" role="tabpanel">
                                    <div class="table-responsive location-table-container mt-3">
                                        <table class="table" id="cities-table">
                                            <thead>
                                                <tr>
                                                    <th>City</th>
                                                    <th>Country</th>
                                                    <th>Visitors</th>
                                                    <th>% of Total</th>
                                                    <th>Last Visit</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- City data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.2/d3.min.js"></script>
    <script>
        // Sample location data (this would normally come from your analytics API)
        const sampleLocationData = {
            countries: [
                { name: "United States", code: "US", visits: 427, firstVisit: "2024-01-15", lastVisit: "2024-04-05" },
                { name: "Vietnam", code: "VN", visits: 312, firstVisit: "2024-01-20", lastVisit: "2024-04-06" },
                { name: "Canada", code: "CA", visits: 198, firstVisit: "2024-02-05", lastVisit: "2024-04-04" },
                { name: "United Kingdom", code: "GB", visits: 156, firstVisit: "2024-02-10", lastVisit: "2024-04-03" },
                { name: "Germany", code: "DE", visits: 132, firstVisit: "2024-02-15", lastVisit: "2024-04-01" },
                { name: "Australia", code: "AU", visits: 117, firstVisit: "2024-02-20", lastVisit: "2024-04-02" },
                { name: "France", code: "FR", visits: 98, firstVisit: "2024-02-25", lastVisit: "2024-03-30" },
                { name: "Japan", code: "JP", visits: 87, firstVisit: "2024-03-01", lastVisit: "2024-04-01" },
                { name: "India", code: "IN", visits: 76, firstVisit: "2024-03-05", lastVisit: "2024-03-31" },
                { name: "Brazil", code: "BR", visits: 65, firstVisit: "2024-03-10", lastVisit: "2024-03-28" },
                { name: "South Korea", code: "KR", visits: 59, firstVisit: "2024-03-15", lastVisit: "2024-04-03" },
                { name: "China", code: "CN", visits: 52, firstVisit: "2024-03-20", lastVisit: "2024-04-04" },
                { name: "Italy", code: "IT", visits: 47, firstVisit: "2024-03-25", lastVisit: "2024-04-02" },
                { name: "Spain", code: "ES", visits: 43, firstVisit: "2024-03-30", lastVisit: "2024-04-05" },
                { name: "Netherlands", code: "NL", visits: 38, firstVisit: "2024-03-31", lastVisit: "2024-04-06" }
            ],
            cities: [
                { name: "Atlanta", country: "United States", visits: 156, lastVisit: "2024-04-05" },
                { name: "Ho Chi Minh City", country: "Vietnam", visits: 143, lastVisit: "2024-04-06" },
                { name: "New York", country: "United States", visits: 98, lastVisit: "2024-04-04" },
                { name: "Toronto", country: "Canada", visits: 87, lastVisit: "2024-04-04" },
                { name: "London", country: "United Kingdom", visits: 76, lastVisit: "2024-04-03" },
                { name: "Hanoi", country: "Vietnam", visits: 65, lastVisit: "2024-04-05" },
                { name: "Berlin", country: "Germany", visits: 54, lastVisit: "2024-04-01" },
                { name: "San Francisco", country: "United States", visits: 49, lastVisit: "2024-04-03" },
                { name: "Sydney", country: "Australia", visits: 43, lastVisit: "2024-04-02" },
                { name: "Paris", country: "France", visits: 41, lastVisit: "2024-03-30" },
                { name: "Chicago", country: "United States", visits: 38, lastVisit: "2024-04-01" },
                { name: "Vancouver", country: "Canada", visits: 36, lastVisit: "2024-04-02" },
                { name: "Tokyo", country: "Japan", visits: 35, lastVisit: "2024-04-01" },
                { name: "Mumbai", country: "India", visits: 32, lastVisit: "2024-03-31" },
                { name: "Los Angeles", country: "United States", visits: 31, lastVisit: "2024-04-02" },
                { name: "Singapore", country: "Singapore", visits: 29, lastVisit: "2024-04-03" },
                { name: "Melbourne", country: "Australia", visits: 28, lastVisit: "2024-03-30" },
                { name: "Dallas", country: "United States", visits: 27, lastVisit: "2024-04-04" },
                { name: "Munich", country: "Germany", visits: 25, lastVisit: "2024-03-29" },
                { name: "Seoul", country: "South Korea", visits: 24, lastVisit: "2024-04-03" },
                { name: "Bangkok", country: "Thailand", visits: 23, lastVisit: "2024-04-02" },
                { name: "Amsterdam", country: "Netherlands", visits: 22, lastVisit: "2024-04-06" },
                { name: "Seattle", country: "United States", visits: 21, lastVisit: "2024-04-01" },
                { name: "Barcelona", country: "Spain", visits: 20, lastVisit: "2024-04-05" },
                { name: "Shanghai", country: "China", visits: 19, lastVisit: "2024-04-04" },
                { name: "Boston", country: "United States", visits: 18, lastVisit: "2024-03-31" },
                { name: "Rome", country: "Italy", visits: 17, lastVisit: "2024-04-02" },
                { name: "Montreal", country: "Canada", visits: 16, lastVisit: "2024-03-30" },
                { name: "São Paulo", country: "Brazil", visits: 15, lastVisit: "2024-03-28" },
                { name: "Hong Kong", country: "China", visits: 14, lastVisit: "2024-03-29" }
            ]
        };

        // Simple admin login
        document.getElementById('admin-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (hash for better security in production)
            if (username === 'teemo' && password === 'Quynh290497*') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                
                // Store login state in sessionStorage
                sessionStorage.setItem('admin-logged-in', 'true');
                
                // Load dashboard data
                loadDashboardData();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });
        
        // Check if already logged in
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('admin-logged-in') === 'true') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadDashboardData();
            }
        });
        
        // Load dashboard data from localStorage
        function loadDashboardData() {
            const today = new Date().toISOString().split('T')[0];
            
            // Total views
            const totalViews = localStorage.getItem('total_views') || '0';
            document.getElementById('total-views').textContent = parseInt(totalViews).toLocaleString();
            
            // Today's views
            const todayViews = localStorage.getItem(`pageviews_${today}`) || '0';
            document.getElementById('today-views').textContent = parseInt(todayViews).toLocaleString();
            
            // Weekly views
            const weeklyViews = calculateWeeklyViews();
            document.getElementById('weekly-views').textContent = weeklyViews.toLocaleString();
            
            // Unique visitors (estimate based on session storage)
            const uniqueVisitors = Math.floor(parseInt(totalViews) * 0.6); // Estimate unique visitors
            document.getElementById('unique-visitors').textContent = uniqueVisitors.toLocaleString();
            
            // Load charts
            loadViewsChart();
            loadSectionsChart();
            loadVisitorTable();
            
            // Load location data
            loadLocationData();
        }
        
        // Calculate weekly views
        function calculateWeeklyViews() {
            let weeklyViews = 0;
            const today = new Date();
            
            // Loop through the last 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                const views = localStorage.getItem(`pageviews_${dateString}`) || '0';
                weeklyViews += parseInt(views);
            }
            
            return weeklyViews;
        }
        
        // Load views chart
        function loadViewsChart() {
            const dates = [];
            const viewsData = [];
            
            // Get data for the last 14 days
            const today = new Date();
            for (let i = 13; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                dates.push(dateString);
                
                const views = localStorage.getItem(`pageviews_${dateString}`) || '0';
                viewsData.push(parseInt(views));
            }
            
            // Create chart
            const ctx = document.getElementById('viewsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Page Views',
                        data: viewsData,
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderColor: 'rgba(0, 122, 255, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Load sections chart
        function loadSectionsChart() {
            const sectionCounts = {
                home: 0,
                about: 0,
                skills: 0,
                projects: 0,
                experience: 0,
                contact: 0
            };
            
            // Calculate section views
            for (let key in localStorage) {
                if (key.startsWith('section_')) {
                    const section = key.split('_')[1];
                    if (sectionCounts.hasOwnProperty(section)) {
                        sectionCounts[section] += parseInt(localStorage.getItem(key) || '0');
                    }
                }
            }
            
            // Prepare data for chart
            const labels = Object.keys(sectionCounts).map(section => 
                section.charAt(0).toUpperCase() + section.slice(1)
            );
            const data = Object.values(sectionCounts);
            const backgroundColors = [
                'rgba(52, 199, 89, 0.7)',    // Green
                'rgba(0, 122, 255, 0.7)',    // Blue
                'rgba(255, 149, 0, 0.7)',    // Orange
                'rgba(175, 82, 222, 0.7)',   // Purple
                'rgba(255, 45, 85, 0.7)',    // Red
                'rgba(90, 200, 250, 0.7)'    // Light Blue
            ];
            
            // Create chart
            const ctx = document.getElementById('sectionsChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Load visitor table
        function loadVisitorTable() {
            const visitorHistory = JSON.parse(localStorage.getItem('visitor_history') || '[]');
            const sectionHistory = JSON.parse(localStorage.getItem('section_history') || '[]');
            
            // Combine histories and sort by timestamp
            const combinedHistory = [...visitorHistory, ...sectionHistory].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            }).slice(0, 10); // Get only the latest 10 entries
            
            const tableBody = document.getElementById('visitor-table');
            tableBody.innerHTML = '';
            
            combinedHistory.forEach(entry => {
                const row = document.createElement('tr');
                
                // Format timestamp
                const timestamp = new Date(entry.timestamp);
                const formattedTime = timestamp.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Create row content based on entry type
                if (entry.section) {
                    // Section history entry
                    row.innerHTML = `
                        <td>${formattedTime}</td>
                        <td>${entry.section.charAt(0).toUpperCase() + entry.section.slice(1)}</td>
                        <td>-</td>
                        <td>-</td>
                    `;
                } else if (entry.data) {
                    // Visitor history entry
                    const screenSize = `${entry.data.screenWidth} x ${entry.data.screenHeight}`;
                    const browser = getBrowserInfo(entry.data.userAgent);
                    
                    row.innerHTML = `
                        <td>${formattedTime}</td>
                        <td>Page View</td>
                        <td>${screenSize}</td>
                        <td>${browser}</td>
                    `;
                }
                
                tableBody.appendChild(row);
            });
        }
        
        // Get browser info from user agent
        function getBrowserInfo(userAgent) {
            if (userAgent.includes('Firefox')) {
                return 'Firefox';
            } else if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
                return 'Chrome';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                return 'Safari';
            } else if (userAgent.includes('Edg')) {
                return 'Edge';
            } else if (userAgent.includes('MSIE') || userAgent.includes('Trident/')) {
                return 'Internet Explorer';
            } else {
                return 'Unknown';
            }
        }
        
        // Load location data - This is where our new functionality begins
        function loadLocationData() {
            // In a real implementation, you'd fetch this data from your backend or analytics API
            // For this demo, we'll use the sample data defined above
            
            // Update location stats overview
            const totalCountries = sampleLocationData.countries.length;
            const totalCities = sampleLocationData.cities.length;
            
            document.getElementById('total-countries').textContent = totalCountries;
            document.getElementById('total-cities').textContent = totalCities;
            
            // Find top country and city
            let topCountry = sampleLocationData.countries.reduce((prev, current) => 
                (prev.visits > current.visits) ? prev : current);
                
            let topCity = sampleLocationData.cities.reduce((prev, current) => 
                (prev.visits > current.visits) ? prev : current);
                
            document.getElementById('top-country').textContent = topCountry.name;
            document.getElementById('top-city').textContent = topCity.name;
            
            // Update count badges
            document.getElementById('countries-count').textContent = totalCountries;
            document.getElementById('cities-count').textContent = totalCities;
            
            // Populate country table
            populateCountryTable();
            
            // Populate city table
            populateCityTable();
            
            // Load world map
            loadWorldMap();
        }
        
        // Populate country table
        function populateCountryTable() {
            const tableBody = document.getElementById('countries-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            // Calculate total visits
            const totalVisits = sampleLocationData.countries.reduce((sum, country) => sum + country.visits, 0);
            
            // Sort countries by visits (descending)
            const sortedCountries = [...sampleLocationData.countries].sort((a, b) => b.visits - a.visits);
            
            sortedCountries.forEach(country => {
                const row = document.createElement('tr');
                
                // Calculate percentage
                const percentage = ((country.visits / totalVisits) * 100).toFixed(1);
                
                // Format dates
                const firstVisit = new Date(country.firstVisit).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const lastVisit = new Date(country.lastVisit).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="flag-icon me-2">${getFlagEmoji(country.code)}</span>
                            <span>${country.name}</span>
                        </div>
                    </td>
                    <td>${country.visits.toLocaleString()}</td>
                    <td>${percentage}%</td>
                    <td>${firstVisit}</td>
                    <td>${lastVisit}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Populate city table
        function populateCityTable() {
            const tableBody = document.getElementById('cities-table').querySelector('tbody');
            tableBody.innerHTML = '';
            
            // Calculate total visits
            const totalVisits = sampleLocationData.cities.reduce((sum, city) => sum + city.visits, 0);
            
            // Sort cities by visits (descending)
            const sortedCities = [...sampleLocationData.cities].sort((a, b) => b.visits - a.visits);
            
            sortedCities.forEach(city => {
                const row = document.createElement('tr');
                
                // Calculate percentage
                const percentage = ((city.visits / totalVisits) * 100).toFixed(1);
                
                // Format last visit date
                const lastVisit = new Date(city.lastVisit).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Find country code for flag
                const countryObj = sampleLocationData.countries.find(c => c.name === city.country);
                const countryCode = countryObj ? countryObj.code : '';
                
                row.innerHTML = `
                    <td>${city.name}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="flag-icon me-2">${getFlagEmoji(countryCode)}</span>
                            <span>${city.country}</span>
                        </div>
                    </td>
                    <td>${city.visits.toLocaleString()}</td>
                    <td>${percentage}%</td>
                    <td>${lastVisit}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Get flag emoji from country code
        function getFlagEmoji(countryCode) {
            if (!countryCode) return '';
            
            // Convert country code to flag emoji
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt(0));
                
            return String.fromCodePoint(...codePoints);
        }
        
        // Search functionality for location tables
        document.getElementById('location-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            // Get active tab
            const activeTab = document.querySelector('.nav-link.active').id;
            
            if (activeTab === 'countries-tab') {
                // Search in countries table
                const rows = document.querySelectorAll('#countries-table tbody tr');
                
                rows.forEach(row => {
                    const countryName = row.querySelector('td:first-child').textContent.toLowerCase();
                    
                    if (countryName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            } else if (activeTab === 'cities-tab') {
                // Search in cities table
                const rows = document.querySelectorAll('#cities-table tbody tr');
                
                rows.forEach(row => {
                    const cityName = row.querySelector('td:first-child').textContent.toLowerCase();
                    const countryName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    
                    if (cityName.includes(searchTerm) || countryName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
        });
        
        // Load world map visualization
        function loadWorldMap() {
            // Get the map container dimensions
            const mapContainer = document.getElementById('world-map');
            const width = mapContainer.clientWidth;
            const height = 400;
            
            // Create SVG element
            const svg = d3.select('#world-map')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('class', 'world-map-svg');
            
            // Create tooltip div
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);
            
            // Define map projection
            const projection = d3.geoNaturalEarth1()
                .scale(width / 5.5)
                .translate([width / 2, height / 2.2]);
            
            // Create geo path generator
            const path = d3.geoPath()
                .projection(projection);
            
            // Create a group for map elements
            const g = svg.append('g');
            
            // Load world map data
            d3.json('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson')
                .then(function(worldData) {
                    // Create country paths
                    g.selectAll('path')
                        .data(worldData.features)
                        .enter()
                        .append('path')
                        .attr('d', path)
                        .attr('class', 'country')
                        .attr('id', d => `country-${d.properties.iso_a3}`)
                        .classed('has-visitors', d => {
                            // Check if this country has visitors
                            return sampleLocationData.countries.some(c => c.code === d.properties.iso_a3);
                        })
                        .on('mouseover', function(event, d) {
                            // Find country data
                            const countryData = sampleLocationData.countries.find(c => 
                                c.code === d.properties.iso_a3
                            );
                            
                            if (countryData) {
                                // Show tooltip
                                tooltip.transition()
                                    .duration(200)
                                    .style('opacity', .9);
                                    
                                tooltip.html(`
                                    <strong>${countryData.name}</strong><br>
                                    Visitors: ${countryData.visits.toLocaleString()}
                                `)
                                    .style('left', (event.pageX + 10) + 'px')
                                    .style('top', (event.pageY - 28) + 'px');
                                    
                                // Highlight country
                                d3.select(this).classed('selected', true);
                            }
                        })
                        .on('mouseout', function() {
                            // Hide tooltip
                            tooltip.transition()
                                .duration(500)
                                .style('opacity', 0);
                                
                            // Remove highlight
                            d3.select(this).classed('selected', false);
                        })
                        .on('click', function(event, d) {
                            // Find country data
                            const countryData = sampleLocationData.countries.find(c => 
                                c.code === d.properties.iso_a3
                            );
                            
                            if (countryData) {
                                // Filter cities table to show only cities from this country
                                document.getElementById('cities-tab').click();
                                
                                const searchInput = document.getElementById('location-search');
                                searchInput.value = countryData.name;
                                searchInput.dispatchEvent(new Event('input'));
                            }
                        });
                        
                    // Add zoom functionality
                    svg.call(d3.zoom()
                        .extent([[0, 0], [width, height]])
                        .scaleExtent([1, 8])
                        .on('zoom', function(event) {
                            g.attr('transform', event.transform);
                        }));
                })
                .catch(function(error) {
                    console.error('Error loading map data:', error);
                    
                    // Show error message in map container
                    mapContainer.innerHTML = `
                        <div class="alert alert-warning text-center m-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to load map visualization. Please check your internet connection.
                        </div>
                    `;
                });
        }
        
        // Initialize Bootstrap tabs
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all tabs
                document.querySelectorAll('.nav-link').forEach(t => {
                    t.classList.remove('active');
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab panes
                document.querySelectorAll('.tab-pane').forEach(p => {
                    p.classList.remove('show', 'active');
                });
                
                // Show selected tab pane
                const target = this.getAttribute('data-bs-target');
                document.querySelector(target).classList.add('show', 'active');
            });
        });
        
        // Store location data in localStorage (in a real implementation)
        function storeLocationData(data) {
            localStorage.setItem('location_data', JSON.stringify(data));
        }
        
        // Function to track user location (in a real implementation)
        function trackUserLocation() {
            // In a real implementation, you would use a geolocation service
            // For this demo, we'll just simulate it
            console.log('Location tracking would be implemented here');
            
            // Example implementation using a third-party geolocation API:
            /*
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    const locationData = {
                        country: data.country_name,
                        countryCode: data.country_code,
                        city: data.city,
                        region: data.region,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Store the location data
                    storeVisitWithLocation(locationData);
                })
                .catch(error => {
                    console.error('Error tracking location:', error);
                });
            */
        }

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tencent Cloud COS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos.min.js"></script>
    <!-- amCharts Resources -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <!-- Portfolio Analytics Script -->
    <script src="/js/tencent-cloud-integration.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #5AC8FA;
            --dark: #121212;
            --light: #F5F5F7;
            --gray: #86868b;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            letter-spacing: -0.015em;
            padding-top: 70px;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.03em;
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .card .card-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
            font-size: 1.25rem;
        }
        
        .stat-card {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .navbar {
            background-color: rgba(245, 245, 247, 0.8) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .table {
            font-size: 0.9rem;
        }
        
        .table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            color: var(--gray);
            border-top: none;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        
        #admin-content {
            display: none;
        }

        #worldMapChart {
            width: 100%;
            height: 400px;
        }

        .geo-stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .geo-stats-container .table-responsive {
            flex: 1;
            min-width: 300px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--gray);
            padding: 0.75rem 1rem;
            font-weight: 500;
            border-radius: 8px;
            margin-right: 0.5rem;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background-color: rgba(0, 122, 255, 0.1);
            border: none;
        }

        .tab-content {
            padding-top: 1.5rem;
        }

        .geo-stat-card {
            text-align: center;
            padding: 1rem;
            border-radius: 12px;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
        }

        .geo-stat-card h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--primary);
        }

        .geo-stat-card p {
            color: var(--gray);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
        }

        .progress {
            height: 8px;
            margin-top: 0.5rem;
            border-radius: 4px;
        }

        .tab-pane.fade {
            transition: opacity 0.15s linear;
        }

        .tab-pane.fade:not(.show) {
            opacity: 0;
        }

        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-container input {
            padding-left: 2.5rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .search-container i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .sync-status .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.75rem;
        }
        
        .sync-status.connected .status-indicator {
            background-color: var(--success);
        }
        
        .sync-status.syncing .status-indicator {
            background-color: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        .sync-status.offline .status-indicator {
            background-color: var(--danger);
        }
        
        .action-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">Minh Duc Nguyen</a>
            <span class="ms-auto">Admin Dashboard</span>
        </div>
    </nav>
    
    <div class="container">
        <!-- Login Form -->
        <div id="login-form" class="login-container card">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">Admin Login</h2>
                <form id="admin-login-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>
                <p id="login-error" class="text-danger mt-3 text-center" style="display: none;">Invalid credentials. Please try again.</p>
            </div>
        </div>
        
        <!-- Admin Dashboard Content -->
        <div id="admin-content">
            <!-- Tencent Cloud Status Bar -->
            <div class="sync-status offline" id="cloud-status">
                <div class="status-indicator"></div>
                <div>
                    <span id="status-text">Connecting to Tencent Cloud...</span>
                    <small id="sync-details" class="text-muted d-block"></small>
                </div>
                <div class="ms-auto">
                    <button id="force-sync-btn" class="btn btn-sm btn-outline-primary">Force Sync</button>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="total-views">--</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="today-views">--</div>
                            <div class="stat-label">Today's Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="weekly-views">--</div>
                            <div class="stat-label">Weekly Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="unique-visitors">--</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Daily Views</h2>
                            <div class="chart-container">
                                <canvas id="viewsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Section Popularity</h2>
                            <div class="chart-container">
                                <canvas id="sectionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Recent Visitor Activity</h2>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>Section</th>
                                            <th>Screen Size</th>
                                            <th>Browser</th>
                                            <th>Location</th>
                                        </tr>
                                    </thead>
                                    <tbody id="visitor-table">
                                        <!-- Table rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Geographic Analytics Dashboard -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Geographic Analytics</h2>
                            
                            <!-- Geographic Stats Summary -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="geo-stat-card">
                                        <h3 id="total-countries">0</h3>
                                        <p>Total Countries</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="geo-stat-card">
                                        <h3 id="total-cities">0</h3>
                                        <p>Total Cities</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="geo-stat-card">
                                        <h3 id="top-country">--</h3>
                                        <p>Top Country</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="geo-stat-card">
                                        <h3 id="top-city">--</h3>
                                        <p>Top City</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- World Map -->
                            <div id="worldMapChart" class="mb-4"></div>
                            
                            <!-- Country & City Data Tabs -->
                            <ul class="nav nav-tabs" id="geoTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="countries-tab" data-bs-toggle="tab" data-bs-target="#countries-tab-pane" type="button" role="tab" aria-controls="countries-tab-pane" aria-selected="true">Countries</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="cities-tab" data-bs-toggle="tab" data-bs-target="#cities-tab-pane" type="button" role="tab" aria-controls="cities-tab-pane" aria-selected="false">Cities</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="geoTabContent">
                                <!-- Countries Tab -->
                                <div class="tab-pane fade show active" id="countries-tab-pane" role="tabpanel" aria-labelledby="countries-tab" tabindex="0">
                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="country-search" class="form-control" placeholder="Search countries...">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Country</th>
                                                    <th>Views</th>
                                                    <th>Percentage</th>
                                                    <th>Distribution</th>
                                                </tr>
                                            </thead>
                                            <tbody id="countries-table">
                                                <!-- Country data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Cities Tab -->
                                <div class="tab-pane fade" id="cities-tab-pane" role="tabpanel" aria-labelledby="cities-tab" tabindex="0">
                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="city-search" class="form-control" placeholder="Search cities...">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>City</th>
                                                    <th>Country</th>
                                                    <th>Views</th>
                                                    <th>Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cities-table">
                                                <!-- City data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Management -->
                            <div class="action-buttons">
                                <button id="export-data-btn" class="btn btn-outline-primary">
                                    <i class="fas fa-download me-2"></i>Export Data
                                </button>
                                <button id="import-data-btn" class="btn btn-outline-secondary">
                                    <i class="fas fa-upload me-2"></i>Import Data
                                </button>
                                <input type="file" id="import-file" accept=".json" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables to track cloud connection state
        let cloudConnected = false;
        let lastSyncTime = null;
        
        // Simple admin login
        document.getElementById('admin-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (hash for better security in production)
            if (username === 'teemo' && password === 'Quynh290497*') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                
                // Store login state in sessionStorage
                sessionStorage.setItem('admin-logged-in', 'true');
                
                // Initialize Tencent Cloud connection
                initializeCloudConnection();
                
                // Load dashboard data
                loadDashboardData();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });
        
        // Check if already logged in
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('admin-logged-in') === 'true') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                
                // Initialize Tencent Cloud connection
                initializeCloudConnection();
                
                // Load dashboard data
                loadDashboardData();
            }
            
            // Set up event listeners for data management buttons
            setupDataManagementButtons();
        });
        
        // Initialize connection to Tencent Cloud
        async function initializeCloudConnection() {
            // Update status to connecting
            updateCloudStatus('syncing', 'Connecting to Tencent Cloud...');
            
            try {
                // Try to initialize Tencent COS
                const cos = await window.portfolioAnalytics.initTencentCOS();
                
                if (cos) {
                    // Connection successful
                    cloudConnected = true;
                    lastSyncTime = new Date();
                    updateCloudStatus('connected', 'Connected to Tencent Cloud');
                    
                    // Force initial sync of local data to cloud
                    await window.portfolioAnalytics.syncDataToTencentCloud();
                    
                    // Schedule regular syncs
                    setInterval(async () => {
                        await window.portfolioAnalytics.syncDataToTencentCloud();
                        lastSyncTime = new Date();
                        updateSyncDetails();
                    }, 5 * 60 * 1000); // Every 5 minutes
                } else {
                    // Connection failed
                    cloudConnected = false;
                    updateCloudStatus('offline', 'Using local storage (Cloud unavailable)');
                }
            } catch (error) {
                console.error('Error connecting to Tencent Cloud:', error);
                cloudConnected = false;
                updateCloudStatus('offline', 'Using local storage (Connection error)');
            }
        }
        
        // Update cloud connection status display
        function updateCloudStatus(status, message) {
            const statusElement = document.getElementById('cloud-status');
            const statusTextElement = document.getElementById('status-text');
            
            // Remove all status classes
            statusElement.classList.remove('connected', 'syncing', 'offline');
            
            // Add current status class
            statusElement.classList.add(status);
            
            // Update status message
            statusTextElement.textContent = message;
            
            // Update sync details
            updateSyncDetails();
        }
        
        // Update sync details display
        function updateSyncDetails() {
            const syncDetailsElement = document.getElementById('sync-details');
            
            if (cloudConnected && lastSyncTime) {
                const timeString = lastSyncTime.toLocaleTimeString();
                syncDetailsElement.textContent = `Last sync: ${timeString}`;
            } else {
                syncDetailsElement.textContent = 'No cloud sync available';
            }
        }
        
        // Load dashboard data from Tencent Cloud (with local fallback)
        async function loadDashboardData() {
            const today = new Date().toISOString().split('T')[0];
            
            // Use portfolio analytics for data fetching (handles cloud vs local)
            try {
                // Total views
                const totalViews = await window.portfolioAnalytics.fetchTencentCloudData('total_views') || '0';
                document.getElementById('total-views').textContent = parseInt(totalViews).toLocaleString();
                
                // Update unique visitors based on total views
                const uniqueVisitors = Math.floor(parseInt(totalViews) * 0.6); // Estimate unique visitors
                document.getElementById('unique-visitors').textContent = uniqueVisitors.toLocaleString();
                
                // Today's views
                const todayViews = await window.portfolioAnalytics.fetchTencentCloudData(`pageviews_${today}`) || '0';
                document.getElementById('today-views').textContent = parseInt(todayViews).toLocaleString();
                
                // Weekly views
                const weeklyViews = await calculateWeeklyViews();
                document.getElementById('weekly-views').textContent = weeklyViews.toLocaleString();
                
                // Load charts and tables
                await loadViewsChart();
                await loadSectionsChart();
                await loadVisitorTable();
                
                // Load geographic data
                await loadGeographicData();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                alert('There was an error loading some dashboard data. Please refresh and try again.');
            }
        }
        
        // Calculate weekly views
        async function calculateWeeklyViews() {
            let weeklyViews = 0;
            const today = new Date();
            
            // Loop through the last 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                const views = await window.portfolioAnalytics.fetchTencentCloudData(`pageviews_${dateString}`) || '0';
                weeklyViews += parseInt(views);
            }
            
            return weeklyViews;
        }
        
        // Load views chart
        async function loadViewsChart() {
            const dates = [];
            const viewsData = [];
            
            // Get data for the last 14 days
            const today = new Date();
            for (let i = 13; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                dates.push(dateString);
                
                const views = await window.portfolioAnalytics.fetchTencentCloudData(`pageviews_${dateString}`) || '0';
                viewsData.push(parseInt(views));
            }
            
            // Create chart
            const ctx = document.getElementById('viewsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Page Views',
                        data: viewsData,
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderColor: 'rgba(0, 122, 255, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Load sections chart
        async function loadSectionsChart() {
            // Get section data
            const sectionData = await window.portfolioAnalytics.fetchTencentCloudData('section_data') || {
                home: 0,
                about: 0,
                skills: 0,
                projects: 0,
                experience: 0,
                contact: 0
            };
            
            // Prepare data for chart
            const labels = Object.keys(sectionData).map(section => 
                section.charAt(0).toUpperCase() + section.slice(1)
            );
            const data = Object.values(sectionData);
            const backgroundColors = [
                'rgba(52, 199, 89, 0.7)',    // Green
                'rgba(0, 122, 255, 0.7)',    // Blue
                'rgba(255, 149, 0, 0.7)',    // Orange
                'rgba(175, 82, 222, 0.7)',   // Purple
                'rgba(255, 45, 85, 0.7)',    // Red
                'rgba(90, 200, 250, 0.7)'    // Light Blue
            ];
            
            // Create chart
            const ctx = document.getElementById('sectionsChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Load visitor table
        async function loadVisitorTable() {
            // Get visitor and section history
            const visitorHistory = await window.portfolioAnalytics.fetchTencentCloudData('visitor_history') || [];
            const sectionHistory = await window.portfolioAnalytics.fetchTencentCloudData('section_history') || [];
            
            // Get geographic data for location information
            const geoData = await window.portfolioAnalytics.fetchTencentCloudData('geo_data') || {
                countries: {},
                cities: {},
                cityCountryMap: {}
            };
            
            // Combine histories and sort by timestamp
            const combinedHistory = [...visitorHistory, ...sectionHistory].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            }).slice(0, 10); // Get only the latest 10 entries
            
            const tableBody = document.getElementById('visitor-table');
            tableBody.innerHTML = '';
            
            combinedHistory.forEach(entry => {
                const row = document.createElement('tr');
                
                // Format timestamp
                const timestamp = new Date(entry.timestamp);
                const formattedTime = timestamp.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Create row content based on entry type
                if (entry.section) {
                    // Section history entry
                    row.innerHTML = `
                        <td>${formattedTime}</td>
                        <td>${entry.section.charAt(0).toUpperCase() + entry.section.slice(1)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                    `;
                } else if (entry.data) {
                    // Visitor history entry
                    const screenSize = `${entry.data.screenWidth} x ${entry.data.screenHeight}`;
                    const browser = getBrowserInfo(entry.data.userAgent);
                    
                    // Try to find location info
                    let location = 'Unknown';
                    if (entry.data.city && entry.data.country) {
                        location = `${entry.data.city}, ${entry.data.country}`;
                    }
                    
                    row.innerHTML = `
                        <td>${formattedTime}</td>
                        <td>Page View</td>
                        <td>${screenSize}</td>
                        <td>${browser}</td>
                        <td>${location}</td>
                    `;
                }
                
                tableBody.appendChild(row);
            });
        }
        
        // Get browser info from user agent
        function getBrowserInfo(userAgent) {
            if (userAgent.includes('Firefox')) {
                return 'Firefox';
            } else if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
                return 'Chrome';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                return 'Safari';
            } else if (userAgent.includes('Edg')) {
                return 'Edge';
            } else if (userAgent.includes('MSIE') || userAgent.includes('Trident/')) {
                return 'Internet Explorer';
            } else {
                return 'Unknown';
            }
        }
        
        // Load geographic data
        async function loadGeographicData() {
            // Get geographic data
            const geoData = await window.portfolioAnalytics.fetchTencentCloudData('geo_data') || {
                countries: {},
                cities: {},
                cityCountryMap: {}
            };
            
            // Update summary stats
            updateGeoSummaryStats(geoData);
            
            // Create world map
            createWorldMap(geoData.countries);
            
            // Populate country table
            populateCountryTable(geoData.countries);
            
            // Populate city table
            populateCityTable(geoData.cities, geoData.cityCountryMap);
            
            // Initialize search functionality
            initializeSearch();
        }
        
        // Update geographic summary statistics
        function updateGeoSummaryStats(geoData) {
            // Count total countries and cities
            const totalCountries = Object.keys(geoData.countries || {}).length;
            const totalCities = Object.keys(geoData.cities || {}).length;
            
            // Find top country
            let topCountry = { name: '--', views: 0 };
            for (const [country, views] of Object.entries(geoData.countries || {})) {
                if (views > topCountry.views) {
                    topCountry = { name: country, views: views };
                }
            }
            
            // Find top city
            let topCity = { name: '--', views: 0 };
            for (const [city, views] of Object.entries(geoData.cities || {})) {
                if (views > topCity.views) {
                    topCity = { name: city, views: views };
                }
            }
            
            // Update UI
            document.getElementById('total-countries').textContent = totalCountries;
            document.getElementById('total-cities').textContent = totalCities;
            document.getElementById('top-country').textContent = topCountry.name;
            document.getElementById('top-city').textContent = topCity.name;
        }
        
        // Create world map visualization
        function createWorldMap(countryData) {
            // Create root element
            const root = am5.Root.new("worldMapChart");
            
            // Set themes
            root.setThemes([am5themes_Animated.new(root)]);
            
            // Create the map chart
            const chart = root.container.children.push(
                am5map.MapChart.new(root, {
                    panX: "rotateX",
                    panY: "none",
                    projection: am5map.geoMercator()
                })
            );
            
            // Create polygon series for countries
            const polygonSeries = chart.series.push(
                am5map.MapPolygonSeries.new(root, {
                    geoJSON: am5geodata_worldLow,
                    exclude: ["AQ"],
                    valueField: "value",
                    calculateAggregates: true
                })
            );
            
            // Configure polygon series
            polygonSeries.mapPolygons.template.setAll({
                tooltipText: "{name}: {value} views",
                interactive: true,
                fill: am5.color(0xDDDDDD),
                stroke: am5.color(0xFFFFFF)
            });
            
            // Heat rule: color countries based on view count
            polygonSeries.set("heatRules", [{
                target: polygonSeries.mapPolygons.template,
                dataField: "value",
                min: am5.color(0x8AB9FF),  // Light blue for low values
                max: am5.color(0x0066CC),  // Dark blue for high values
                key: "fill"
            }]);
            
            // Set data for countries
            const polygonData = [];
            for (const [countryName, views] of Object.entries(countryData || {})) {
                const id = getCountryCode(countryName);
                if (id) {
                    polygonData.push({
                        id: id,
                        name: countryName,
                        value: views
                    });
                }
            }
            polygonSeries.data.setAll(polygonData);
            
            // Add zoom control
            chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
            
            // Create hover state
            const hoverState = polygonSeries.mapPolygons.template.states.create("hover", {
                fill: am5.color(0x025BBD)
            });
            
            // Enable small map control
            chart.set("smallMap", am5map.SmallMap.new(root, {
                series: polygonSeries
            }));
            
            // Return chart for cleanup if needed
            return chart;
        }
        
        // Populate country table
        function populateCountryTable(countryData) {
            const tableBody = document.getElementById('countries-table');
            tableBody.innerHTML = '';
            
            // Get total views
            const totalViews = Object.values(countryData || {}).reduce((sum, views) => sum + views, 0);
            
            // If no data, display message
            if (totalViews === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" class="text-center">No country data available yet</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            // Sort countries by views (descending)
            const sortedCountries = Object.entries(countryData || {})
                .sort((a, b) => b[1] - a[1])
                .map(([country, views]) => ({ country, views }));
            
            // Create table rows
            sortedCountries.forEach(({ country, views }) => {
                const percentage = totalViews > 0 ? ((views / totalViews) * 100).toFixed(2) : '0.00';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${country}</td>
                    <td>${views.toLocaleString()}</td>
                    <td>${percentage}%</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: ${percentage}%" 
                                aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Populate city table
        function populateCityTable(cityData, cityCountryMap) {
            const tableBody = document.getElementById('cities-table');
            tableBody.innerHTML = '';
            
            // Get total views
            const totalViews = Object.values(cityData || {}).reduce((sum, views) => sum + views, 0);
            
            // If no data, display message
            if (totalViews === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" class="text-center">No city data available yet</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            // Sort cities by views (descending)
            const sortedCities = Object.entries(cityData || {})
                .sort((a, b) => b[1] - a[1])
                .map(([city, views]) => ({ 
                    city, 
                    views, 
                    country: cityCountryMap?.[city] || 'Unknown'
                }));
            
            // Create table rows
            sortedCities.forEach(({ city, country, views }) => {
                const percentage = totalViews > 0 ? ((views / totalViews) * 100).toFixed(2) : '0.00';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${city}</td>
                    <td>${country}</td>
                    <td>${views.toLocaleString()}</td>
                    <td>${percentage}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Initialize search functionality
        function initializeSearch() {
            // Country search
            const countrySearch = document.getElementById('country-search');
            countrySearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#countries-table tr');
                
                rows.forEach(row => {
                    if (row.cells.length === 1) return; // Skip "no data" row
                    
                    const countryName = row.querySelector('td:first-child')?.textContent.toLowerCase();
                    row.style.display = countryName?.includes(searchTerm) ? '' : 'none';
                });
            });
            
            // City search
            const citySearch = document.getElementById('city-search');
            citySearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#cities-table tr');
                
                rows.forEach(row => {
                    if (row.cells.length === 1) return; // Skip "no data" row
                    
                    const cityName = row.querySelector('td:first-child')?.textContent.toLowerCase();
                    const countryName = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase();
                    row.style.display = (cityName?.includes(searchTerm) || countryName?.includes(searchTerm)) ? '' : 'none';
                });
            });
        }
        
        // Helper function to convert country name to ISO country code (for amCharts)
        function getCountryCode(countryName) {
            const countryMap = {
                "United States": "US",
                "China": "CN",
                "India": "IN",
                "Japan": "JP",
                "Germany": "DE",
                "United Kingdom": "GB",
                "France": "FR",
                "Italy": "IT",
                "Brazil": "BR",
                "Canada": "CA",
                "South Korea": "KR",
                "Russia": "RU",
                "Australia": "AU",
                "Spain": "ES",
                "Mexico": "MX",
                "Indonesia": "ID",
                "Netherlands": "NL",
                "Saudi Arabia": "SA",
                "Switzerland": "CH",
                "Turkey": "TR",
                "Taiwan": "TW",
                "Poland": "PL",
                "Sweden": "SE",
                "Belgium": "BE",
                "Thailand": "TH",
                "Argentina": "AR",
                "Austria": "AT",
                "Vietnam": "VN",
                "Singapore": "SG",
                "Hong Kong": "HK",
                "South Africa": "ZA",
                "Denmark": "DK",
                "Egypt": "EG",
                "Finland": "FI",
                "Norway": "NO",
                "Malaysia": "MY",
                "Philippines": "PH",
                "Chile": "CL",
                "Ireland": "IE",
                "Pakistan": "PK",
                "Portugal": "PT",
                "Czech Republic": "CZ",
                "Romania": "RO",
                "New Zealand": "NZ",
                "Hungary": "HU",
                "Greece": "GR",
                "Israel": "IL",
                "Ukraine": "UA",
                "Colombia": "CO",
                "United Arab Emirates": "AE",
                // Add more as needed
            };
            
            return countryMap[countryName] || null;
        }
        
        // Setup data management buttons
        function setupDataManagementButtons() {
            // Force sync button
            document.getElementById('force-sync-btn').addEventListener('click', async function() {
                if (!cloudConnected) {
                    alert('Cannot sync to cloud - connection not available.');
                    return;
                }
                
                try {
                    // Show syncing status
                    updateCloudStatus('syncing', 'Syncing data to Tencent Cloud...');
                    
                    // Perform sync
                    await window.portfolioAnalytics.syncDataToTencentCloud();
                    
                    // Update status
                    lastSyncTime = new Date();
                    updateCloudStatus('connected', 'Connected to Tencent Cloud');
                    
                    alert('Data successfully synced to Tencent Cloud!');
                } catch (error) {
                    console.error('Error syncing data:', error);
                    updateCloudStatus('offline', 'Sync failed - check console for details');
                    alert('Failed to sync data. See console for details.');
                }
            });
            
            // Export data button
            document.getElementById('export-data-btn').addEventListener('click', async function() {
                try {
                    // Collect all analytics data
                    const exportData = {
                        total_views: await window.portfolioAnalytics.fetchTencentCloudData('total_views'),
                        visitor_history: await window.portfolioAnalytics.fetchTencentCloudData('visitor_history'),
                        section_history: await window.portfolioAnalytics.fetchTencentCloudData('section_history'),
                        section_data: await window.portfolioAnalytics.fetchTencentCloudData('section_data'),
                        geo_data: await window.portfolioAnalytics.fetchTencentCloudData('geo_data'),
                        export_date: new Date().toISOString(),
                        source: cloudConnected ? 'Tencent Cloud' : 'Local Storage'
                    };
                    
                    // Create blob and download link
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    // Create download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `portfolio-analytics-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error exporting data:', error);
                    alert('Failed to export data. See console for details.');
                }
            });
            
            // Import data button
            document.getElementById('import-data-btn').addEventListener('click', function() {
                document.getElementById('import-file').click();
            });
            
            // Handle file selection for import
            document.getElementById('import-file').addEventListener('change', async function(e) {
                if (!this.files || !this.files[0]) return;
                
                try {
                    const file = this.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = async function(event) {
                        try {
                            // Parse imported data
                            const importData = JSON.parse(event.target.result);
                            
                            // Confirm import
                            if (!confirm(`Are you sure you want to import this data?\nThis will overwrite existing data.\n\nExport date: ${new Date(importData.export_date).toLocaleString()}\nSource: ${importData.source}`)) {
                                return;
                            }
                            
                            // Show syncing status
                            updateCloudStatus('syncing', 'Importing data...');
                            
                            // Import each data category
                            for (const [key, value] of Object.entries(importData)) {
                                // Skip metadata fields
                                if (['export_date', 'source'].includes(key)) continue;
                                
                                // Store in localStorage
                                localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
                                
                                // Mark for cloud sync
                                window.portfolioAnalytics.markForSync(key);
                            }
                            
                            // Sync to cloud if connected
                            if (cloudConnected) {
                                await window.portfolioAnalytics.syncDataToTencentCloud();
                                lastSyncTime = new Date();
                                updateCloudStatus('connected', 'Connected to Tencent Cloud');
                            } else {
                                updateCloudStatus('offline', 'Data imported to local storage only');
                            }
                            
                            // Reload dashboard
                            alert('Data imported successfully! The dashboard will now reload.');
                            loadDashboardData();
                        } catch (error) {
                            console.error('Error processing import file:', error);
                            alert('Failed to import data. The file may be invalid or corrupted.');
                            updateCloudStatus(cloudConnected ? 'connected' : 'offline', 
                                cloudConnected ? 'Connected to Tencent Cloud' : 'Using local storage');
                        }
                    };
                    
                    reader.readAsText(file);
                } catch (error) {
                    console.error('Error reading import file:', error);
                    alert('Failed to read import file.');
                }
                
                // Reset file input
                this.value = '';
            });
        }
    </script>
</body>
</html>
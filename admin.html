<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- amCharts Resources -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #5AC8FA;
            --dark: #121212;
            --light: #F5F5F7;
            --gray: #86868b;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            letter-spacing: -0.015em;
            padding-top: 70px;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.03em;
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .card .card-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
            font-size: 1.25rem;
        }
        
        .stat-card {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .navbar {
            background-color: rgba(245, 245, 247, 0.8) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .table {
            font-size: 0.9rem;
        }
        
        .table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            color: var(--gray);
            border-top: none;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        
        #admin-content {
            display: none;
        }

        #worldMapChart {
            width: 100%;
            height: 400px;
        }

        .geo-stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .geo-stats-container .table-responsive {
            flex: 1;
            min-width: 300px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--gray);
            padding: 0.75rem 1rem;
            font-weight: 500;
            border-radius: 8px;
            margin-right: 0.5rem;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background-color: rgba(0, 122, 255, 0.1);
            border: none;
        }

        .tab-content {
            padding-top: 1.5rem;
        }

        .geo-stat-card {
            text-align: center;
            padding: 1rem;
            border-radius: 12px;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
        }

        .geo-stat-card h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--primary);
        }

        .geo-stat-card p {
            color: var(--gray);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
        }

        .progress {
            height: 8px;
            margin-top: 0.5rem;
            border-radius: 4px;
        }

        .tab-pane.fade {
            transition: opacity 0.15s linear;
        }

        .tab-pane.fade:not(.show) {
            opacity: 0;
        }

        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-container input {
            padding-left: 2.5rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .search-container i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">Minh Duc Nguyen</a>
            <span class="ms-auto">Admin Dashboard</span>
        </div>
    </nav>
    
    <div class="container">
        <!-- Login Form -->
        <div id="login-form" class="login-container card">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">Admin Login</h2>
                <form id="admin-login-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>
                <p id="login-error" class="text-danger mt-3 text-center" style="display: none;">Invalid credentials. Please try again.</p>
            </div>
        </div>
        
        <!-- Admin Dashboard Content -->
        <div id="admin-content">
            <div class="row mt-4">
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="total-views">--</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="today-views">--</div>
                            <div class="stat-label">Today's Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="weekly-views">--</div>
                            <div class="stat-label">Weekly Views</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="stat-value" id="unique-visitors">--</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Daily Views</h2>
                            <div class="chart-container">
                                <canvas id="viewsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Section Popularity</h2>
                            <div class="chart-container">
                                <canvas id="sectionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Recent Visitor Activity</h2>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>Section</th>
                                            <th>Screen Size</th>
                                            <th>Browser</th>
                                        </tr>
                                    </thead>
                                    <tbody id="visitor-table">
                                        <!-- Table rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Geographic Analytics Dashboard (Replacing External Analytics Dashboard) -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Geographic Analytics</h2>
                            
                            <!-- Geographic Stats Summary -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="geo-stat-card">
                                        <h3 id="total-countries">0</h3>
                                        <p>Total Countries</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="geo-stat-card">
                                        <h3 id="total-cities">0</h3>
                                        <p>Total Cities</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="geo-stat-card">
                                        <h3 id="top-country">--</h3>
                                        <p>Top Country</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="geo-stat-card">
                                        <h3 id="top-city">--</h3>
                                        <p>Top City</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- World Map -->
                            <div id="worldMapChart" class="mb-4"></div>
                            
                            <!-- Country & City Data Tabs -->
                            <ul class="nav nav-tabs" id="geoTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="countries-tab" data-bs-toggle="tab" data-bs-target="#countries-tab-pane" type="button" role="tab" aria-controls="countries-tab-pane" aria-selected="true">Countries</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="cities-tab" data-bs-toggle="tab" data-bs-target="#cities-tab-pane" type="button" role="tab" aria-controls="cities-tab-pane" aria-selected="false">Cities</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="geoTabContent">
                                <!-- Countries Tab -->
                                <div class="tab-pane fade show active" id="countries-tab-pane" role="tabpanel" aria-labelledby="countries-tab" tabindex="0">
                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="country-search" class="form-control" placeholder="Search countries...">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Country</th>
                                                    <th>Views</th>
                                                    <th>Percentage</th>
                                                    <th>Distribution</th>
                                                </tr>
                                            </thead>
                                            <tbody id="countries-table">
                                                <!-- Country data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Cities Tab -->
                                <div class="tab-pane fade" id="cities-tab-pane" role="tabpanel" aria-labelledby="cities-tab" tabindex="0">
                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="city-search" class="form-control" placeholder="Search cities...">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>City</th>
                                                    <th>Country</th>
                                                    <th>Views</th>
                                                    <th>Percentage</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cities-table">
                                                <!-- City data will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Simple admin login
        document.getElementById('admin-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (hash for better security in production)
            if (username === 'teemo' && password === 'Quynh290497*') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                
                // Store login state in sessionStorage
                sessionStorage.setItem('admin-logged-in', 'true');
                
                // Load dashboard data
                loadDashboardData();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });
        
        // Check if already logged in
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('admin-logged-in') === 'true') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadDashboardData();
            }
        });
        
        // Load dashboard data from Tencent Cloud (simulated)
        function loadDashboardData() {
            const today = new Date().toISOString().split('T')[0];
            
            // Total views - getting from Tencent Cloud (simulated)
            fetchTencentCloudData('total_views').then(data => {
                const totalViews = data || '0';
                document.getElementById('total-views').textContent = parseInt(totalViews).toLocaleString();
                
                // Update unique visitors based on total views
                const uniqueVisitors = Math.floor(parseInt(totalViews) * 0.6); // Estimate unique visitors
                document.getElementById('unique-visitors').textContent = uniqueVisitors.toLocaleString();
            });
            
            // Today's views
            fetchTencentCloudData(`pageviews_${today}`).then(data => {
                const todayViews = data || '0';
                document.getElementById('today-views').textContent = parseInt(todayViews).toLocaleString();
            });
            
            // Weekly views
            calculateWeeklyViews().then(weeklyViews => {
                document.getElementById('weekly-views').textContent = weeklyViews.toLocaleString();
            });
            
            // Load charts and tables
            loadViewsChart();
            loadSectionsChart();
            loadVisitorTable();
            
            // Load geographic data
            loadGeographicData();
        }
        
        // Calculate weekly views from Tencent Cloud (simulated)
        async function calculateWeeklyViews() {
            let weeklyViews = 0;
            const today = new Date();
            
            // Loop through the last 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                const views = await fetchTencentCloudData(`pageviews_${dateString}`) || '0';
                weeklyViews += parseInt(views);
            }
            
            return weeklyViews;
        }
        
        // Load views chart
        async function loadViewsChart() {
            const dates = [];
            const viewsData = [];
            
            // Get data for the last 14 days
            const today = new Date();
            for (let i = 13; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                dates.push(dateString);
                
                const views = await fetchTencentCloudData(`pageviews_${dateString}`) || '0';
                viewsData.push(parseInt(views));
            }
            
            // Create chart
            const ctx = document.getElementById('viewsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Page Views',
                        data: viewsData,
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderColor: 'rgba(0, 122, 255, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Load sections chart
        async function loadSectionsChart() {
            // Get section data from Tencent Cloud (simulated)
            const sectionData = await fetchTencentCloudData('section_data') || {
                home: 0,
                about: 0,
                skills: 0,
                projects: 0,
                experience: 0,
                contact: 0
            };
            
            // Prepare data for chart
            const labels = Object.keys(sectionData).map(section => 
                section.charAt(0).toUpperCase() + section.slice(1)
            );
            const data = Object.values(sectionData);
            const backgroundColors = [
                'rgba(52, 199, 89, 0.7)',    // Green
                'rgba(0, 122, 255, 0.7)',    // Blue
                'rgba(255, 149, 0, 0.7)',    // Orange
                'rgba(175, 82, 222, 0.7)',   // Purple
                'rgba(255, 45, 85, 0.7)',    // Red
                'rgba(90, 200, 250, 0.7)'    // Light Blue
            ];
            
            // Create chart
            const ctx = document.getElementById('sectionsChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Load visitor table
        async function loadVisitorTable() {
            // Get visitor history from Tencent Cloud (simulated)
            const visitorHistory = await fetchTencentCloudData('visitor_history') || [];
            const sectionHistory = await fetchTencentCloudData('section_history') || [];
            
            // Combine histories and sort by timestamp
            const combinedHistory = [...visitorHistory, ...sectionHistory].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            }).slice(0, 10); // Get only the latest 10 entries
            
            const tableBody = document.getElementById('visitor-table');
            tableBody.innerHTML = '';
            
            combinedHistory.forEach(entry => {
                const row = document.createElement('tr');
                
                // Format timestamp
                const timestamp = new Date(entry.timestamp);
                const formattedTime = timestamp.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Create row content based on entry type
                if (entry.section) {
                    // Section history entry
                    row.innerHTML = `
                        <td>${formattedTime}</td>
                        <td>${entry.section.charAt(0).toUpperCase() + entry.section.slice(1)}</td>
                        <td>-</td>
                        <td>-</td>
                    `;
                } else if (entry.data) {
                    // Visitor history entry
                    const screenSize = `${entry.data.screenWidth} x ${entry.data.screenHeight}`;
                    const browser = getBrowserInfo(entry.data.userAgent);
                    
                    row.innerHTML = `
                        <td>${formattedTime}</td>
                        <td>Page View</td>
                        <td>${screenSize}</td>
                        <td>${browser}</td>
                    `;
                }
                
                tableBody.appendChild(row);
            });
        }
        
        // Get browser info from user agent
        function getBrowserInfo(userAgent) {
            if (userAgent.includes('Firefox')) {
                return 'Firefox';
            } else if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
                return 'Chrome';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                return 'Safari';
            } else if (userAgent.includes('Edg')) {
                return 'Edge';
            } else if (userAgent.includes('MSIE') || userAgent.includes('Trident/')) {
                return 'Internet Explorer';
            } else {
                return 'Unknown';
            }
        }
        
        // Load geographic data
        async function loadGeographicData() {
            // Get geographic data from Tencent Cloud (simulated)
            const geoData = await fetchTencentCloudData('geo_data') || {
                countries: {},
                cities: {}
            };
            
            // Update summary stats
            updateGeoSummaryStats(geoData);
            
            // Create world map
            createWorldMap(geoData.countries);
            
            // Populate country table
            populateCountryTable(geoData.countries);
            
            // Populate city table
            populateCityTable(geoData.cities, geoData.cityCountryMap || {});
            
            // Initialize search functionality
            initializeSearch();
        }
        
        // Update geographic summary statistics
        function updateGeoSummaryStats(geoData) {
            // Count total countries and cities
            const totalCountries = Object.keys(geoData.countries).length;
            const totalCities = Object.keys(geoData.cities).length;
            
            // Find top country
            let topCountry = { name: '--', views: 0 };
            for (const [country, views] of Object.entries(geoData.countries)) {
                if (views > topCountry.views) {
                    topCountry = { name: country, views: views };
                }
            }
            
            // Find top city
            let topCity = { name: '--', views: 0 };
            for (const [city, views] of Object.entries(geoData.cities)) {
                if (views > topCity.views) {
                    topCity = { name: city, views: views };
                }
            }
            
            // Update UI
            document.getElementById('total-countries').textContent = totalCountries;
            document.getElementById('total-cities').textContent = totalCities;
            document.getElementById('top-country').textContent = topCountry.name;
            document.getElementById('top-city').textContent = topCity.name;
        }
        
        // Create world map visualization
        function createWorldMap(countryData) {
            // Create root element
            const root = am5.Root.new("worldMapChart");
            
            // Set themes
            root.setThemes([am5themes_Animated.new(root)]);
            
            // Create the map chart
            const chart = root.container.children.push(
                am5map.MapChart.new(root, {
                    panX: "rotateX",
                    panY: "none",
                    projection: am5map.geoMercator()
                })
            );
            
            // Create polygon series for countries
            const polygonSeries = chart.series.push(
                am5map.MapPolygonSeries.new(root, {
                    geoJSON: am5geodata_worldLow,
                    exclude: ["AQ"],
                    valueField: "value",
                    calculateAggregates: true
                })
            );
            
            // Configure polygon series
            polygonSeries.mapPolygons.template.setAll({
                tooltipText: "{name}: {value} views",
                interactive: true,
                fill: am5.color(0xDDDDDD),
                stroke: am5.color(0xFFFFFF)
            });
            
            // Heat rule: color countries based on view count
            polygonSeries.set("heatRules", [{
                target: polygonSeries.mapPolygons.template,
                dataField: "value",
                min: am5.color(0x8AB9FF),  // Light blue for low values
                max: am5.color(0x0066CC),  // Dark blue for high values
                key: "fill"
            }]);
            
            // Set data for countries
            const polygonData = [];
            for (const [countryName, views] of Object.entries(countryData)) {
                const id = getCountryCode(countryName);
                if (id) {
                    polygonData.push({
                        id: id,
                        name: countryName,
                        value: views
                    });
                }
            }
            polygonSeries.data.setAll(polygonData);
            
            // Add zoom control
            chart.set("zoomControl", am5map.ZoomControl.new(root, {}));
            
            // Create hover state
            const hoverState = polygonSeries.mapPolygons.template.states.create("hover", {
                fill: am5.color(0x025BBD)
            });
            
            // Enable small map control
            chart.set("smallMap", am5map.SmallMap.new(root, {
                series: polygonSeries
            }));
            
            // Return chart for cleanup if needed
            return chart;
        }
        
        // Populate country table
        function populateCountryTable(countryData) {
            const tableBody = document.getElementById('countries-table');
            tableBody.innerHTML = '';
            
            // Get total views
            const totalViews = Object.values(countryData).reduce((sum, views) => sum + views, 0);
            
            // Sort countries by views (descending)
            const sortedCountries = Object.entries(countryData)
                .sort((a, b) => b[1] - a[1])
                .map(([country, views]) => ({ country, views }));
            
            // Create table rows
            sortedCountries.forEach(({ country, views }) => {
                const percentage = totalViews > 0 ? ((views / totalViews) * 100).toFixed(2) : '0.00';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${country}</td>
                    <td>${views.toLocaleString()}</td>
                    <td>${percentage}%</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: ${percentage}%" 
                                aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Populate city table
        function populateCityTable(cityData, cityCountryMap) {
            const tableBody = document.getElementById('cities-table');
            tableBody.innerHTML = '';
            
            // Get total views
            const totalViews = Object.values(cityData).reduce((sum, views) => sum + views, 0);
            
            // Sort cities by views (descending)
            const sortedCities = Object.entries(cityData)
                .sort((a, b) => b[1] - a[1])
                .map(([city, views]) => ({ 
                    city, 
                    views, 
                    country: cityCountryMap[city] || 'Unknown'
                }));
            
            // Create table rows
            sortedCities.forEach(({ city, country, views }) => {
                const percentage = totalViews > 0 ? ((views / totalViews) * 100).toFixed(2) : '0.00';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${city}</td>
                    <td>${country}</td>
                    <td>${views.toLocaleString()}</td>
                    <td>${percentage}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Initialize search functionality
        function initializeSearch() {
            // Country search
            const countrySearch = document.getElementById('country-search');
            countrySearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#countries-table tr');
                
                rows.forEach(row => {
                    const countryName = row.querySelector('td:first-child').textContent.toLowerCase();
                    row.style.display = countryName.includes(searchTerm) ? '' : 'none';
                });
            });
            
            // City search
            const citySearch = document.getElementById('city-search');
            citySearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#cities-table tr');
                
                rows.forEach(row => {
                    const cityName = row.querySelector('td:first-child').textContent.toLowerCase();
                    const countryName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    row.style.display = cityName.includes(searchTerm) || countryName.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        
        // Helper function to convert country name to ISO country code (for amCharts)
        function getCountryCode(countryName) {
            const countryMap = {
                "United States": "US",
                "China": "CN",
                "India": "IN",
                "Japan": "JP",
                "Germany": "DE",
                "United Kingdom": "GB",
                "France": "FR",
                "Italy": "IT",
                "Brazil": "BR",
                "Canada": "CA",
                "South Korea": "KR",
                "Russia": "RU",
                "Australia": "AU",
                "Spain": "ES",
                "Mexico": "MX",
                "Indonesia": "ID",
                "Netherlands": "NL",
                "Saudi Arabia": "SA",
                "Switzerland": "CH",
                "Turkey": "TR",
                "Taiwan": "TW",
                "Poland": "PL",
                "Sweden": "SE",
                "Belgium": "BE",
                "Thailand": "TH",
                "Argentina": "AR",
                "Austria": "AT",
                "Vietnam": "VN",
                "Singapore": "SG",
                "Hong Kong": "HK",
                "South Africa": "ZA",
                "Denmark": "DK",
                "Egypt": "EG",
                "Finland": "FI",
                "Norway": "NO",
                "Malaysia": "MY",
                "Philippines": "PH",
                "Chile": "CL",
                "Ireland": "IE",
                "Pakistan": "PK",
                "Portugal": "PT",
                "Czech Republic": "CZ",
                "Romania": "RO",
                "New Zealand": "NZ",
                "Hungary": "HU",
                "Greece": "GR",
                "Israel": "IL",
                "Ukraine": "UA",
                "Colombia": "CO",
                "United Arab Emirates": "AE",
                // Add more as needed
            };
            
            return countryMap[countryName] || null;
        }
        
        // Simulate fetching data from Tencent Cloud
        // In production, replace with actual Tencent Cloud SDK calls
        async function fetchTencentCloudData(key) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Mock data for demonstration
            const mockData = {
                total_views: 15876,
                'pageviews_2025-04-06': 346,
                'pageviews_2025-04-05': 412,
                'pageviews_2025-04-04': 389,
                'pageviews_2025-04-03': 427,
                'pageviews_2025-04-02': 401,
                'pageviews_2025-04-01': 375,
                'pageviews_2025-03-31': 356,
                section_data: {
                    home: 5248,
                    about: 3421,
                    skills: 2976,
                    projects: 4132,
                    experience: 2874,
                    contact: 1523
                },
                visitor_history: [
                    {
                        timestamp: '2025-04-06T14:23:45.000Z',
                        data: {
                            screenWidth: 1920,
                            screenHeight: 1080,
                            userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36'
                        }
                    },
                    {
                        timestamp: '2025-04-06T13:56:12.000Z',
                        data: {
                            screenWidth: 1440,
                            screenHeight: 900,
                            userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Safari/605.1.15'
                        }
                    }
                ],
                section_history: [
                    {
                        timestamp: '2025-04-06T14:25:18.000Z',
                        section: 'projects'
                    },
                    {
                        timestamp: '2025-04-06T14:02:37.000Z',
                        section: 'skills'
                    }
                ],
                geo_data: {
                    countries: {
                        "United States": 4256,
                        "China": 2187,
                        "India": 1945,
                        "Germany": 1124,
                        "United Kingdom": 982,
                        "Canada": 876,
                        "Australia": 743,
                        "Japan": 687,
                        "France": 634,
                        "Brazil": 589,
                        "South Korea": 456,
                        "Mexico": 432,
                        "Russia": 387,
                        "Italy": 352,
                        "Spain": 327,
                        "Netherlands": 298,
                        "Indonesia": 265,
                        "Vietnam": 243,
                        "Singapore": 237,
                        "Poland": 226,
                        "Switzerland": 198,
                        "Sweden": 187,
                        "Turkey": 176,
                        "Egypt": 154,
                        "South Africa": 142,
                        "Thailand": 138,
                        "Malaysia": 132,
                        "Philippines": 127,
                        "Belgium": 118,
                        "Denmark": 109,
                        "Israel": 98,
                        "Argentina": 94,
                        "Finland": 92,
                        "Norway": 87,
                        "Austria": 82,
                        "Portugal": 76,
                        "New Zealand": 68,
                        "Ireland": 64,
                        "Greece": 57,
                        "Czech Republic": 54,
                        "Romania": 49,
                        "Hungary": 46,
                        "Colombia": 42,
                        "Ukraine": 38,
                        "Pakistan": 36,
                        "Chile": 33,
                        "United Arab Emirates": 31
                    },
                    cities: {
                        "Atlanta": 1245,
                        "New York": 876,
                        "San Francisco": 765,
                        "Beijing": 687,
                        "Bangalore": 643,
                        "London": 598,
                        "Toronto": 534,
                        "Berlin": 487,
                        "Sydney": 456,
                        "Tokyo": 432,
                        "Shanghai": 421,
                        "Mumbai": 398,
                        "Paris": 387,
                        "Chicago": 354,
                        "Seattle": 342,
                        "Boston": 326,
                        "Los Angeles": 312,
                        "Austin": 298,
                        "Singapore": 287,
                        "Delhi": 276,
                        "Hong Kong": 265,
                        "Melbourne": 254,
                        "Vancouver": 243,
                        "Amsterdam": 232,
                        "Munich": 221,
                        "Seoul": 212,
                        "Dallas": 198,
                        "Miami": 187,
                        "Houston": 176,
                        "Madrid": 165,
                        "Barcelona": 154,
                        "Rome": 143,
                        "Milan": 132,
                        "Montreal": 129,
                        "São Paulo": 126,
                        "Mexico City": 122,
                        "Stockholm": 118,
                        "Dubai": 112,
                        "Brussels": 104,
                        "Vienna": 98,
                        "Dublin": 94,
                        "Helsinki": 89,
                        "Oslo": 87,
                        "Warsaw": 83,
                        "Budapest": 76,
                        "Prague": 72,
                        "Zurich": 68,
                        "Copenhagen": 65,
                        "Bangkok": 62,
                        "Manila": 58,
                        "Jakarta": 54,
                        "Kuala Lumpur": 52,
                        "Cape Town": 48,
                        "Cairo": 45,
                        "Tel Aviv": 43,
                        "Lisbon": 41,
                        "Athens": 38,
                        "Bucharest": 35,
                        "Kiev": 32,
                        "Johannesburg": 29
                    },
                    cityCountryMap: {
                        "Atlanta": "United States",
                        "New York": "United States",
                        "San Francisco": "United States",
                        "Beijing": "China",
                        "Bangalore": "India",
                        "London": "United Kingdom",
                        "Toronto": "Canada",
                        "Berlin": "Germany",
                        "Sydney": "Australia",
                        "Tokyo": "Japan",
                        "Shanghai": "China",
                        "Mumbai": "India",
                        "Paris": "France",
                        "Chicago": "United States",
                        "Seattle": "United States",
                        "Boston": "United States",
                        "Los Angeles": "United States",
                        "Austin": "United States",
                        "Singapore": "Singapore",
                        "Delhi": "India",
                        "Hong Kong": "China",
                        "Melbourne": "Australia",
                        "Vancouver": "Canada",
                        "Amsterdam": "Netherlands",
                        "Munich": "Germany",
                        "Seoul": "South Korea",
                        "Dallas": "United States",
                        "Miami": "United States",
                        "Houston": "United States",
                        "Madrid": "Spain",
                        "Barcelona": "Spain",
                        "Rome": "Italy",
                        "Milan": "Italy",
                        "Montreal": "Canada",
                        "São Paulo": "Brazil",
                        "Mexico City": "Mexico",
                        "Stockholm": "Sweden",
                        "Dubai": "United Arab Emirates",
                        "Brussels": "Belgium",
                        "Vienna": "Austria",
                        "Dublin": "Ireland",
                        "Helsinki": "Finland",
                        "Oslo": "Norway",
                        "Warsaw": "Poland",
                        "Budapest": "Hungary",
                        "Prague": "Czech Republic",
                        "Zurich": "Switzerland",
                        "Copenhagen": "Denmark",
                        "Bangkok": "Thailand",
                        "Manila": "Philippines",
                        "Jakarta": "Indonesia",
                        "Kuala Lumpur": "Malaysia",
                        "Cape Town": "South Africa",
                        "Cairo": "Egypt",
                        "Tel Aviv": "Israel",
                        "Lisbon": "Portugal",
                        "Athens": "Greece",
                        "Bucharest": "Romania",
                        "Kiev": "Ukraine",
                        "Johannesburg": "South Africa"
                    }
                }
            };
            
            return mockData[key] || null;
        }
        
        async function initTencentCloudSDK() {
            // Import Tencent Cloud SDK
            const COS = require('cos-nodejs-sdk-v5');
            
            // Initialize with your credentials
            const cos = new COS({
                SecretId: 'IKIDureIj0OZXKxTvIUVOFza3JPNBrMfnncE',
                SecretKey: 'WpyveBZklcKuLZhnkDZyDJqIgswxpV4U'
            });
            
            return cos;
        }
        
        async function fetchDataFromTencentCloud(key) {
            try {
                const cos = await initTencentCloudSDK();
                
                const result = await cos.getObject({
                    Bucket: 'website-traffic-1352137578',
                    Region: 'ap-bangkok',
                    Key: `analytics/${key}.json`
                });
                
                return JSON.parse(result.Body.toString());
            } catch (error) {
                console.error('Error fetching data from Tencent Cloud:', error);
                return null;
            }
        }
        
        async function saveDataToTencentCloud(key, data) {
            try {
                const cos = await initTencentCloudSDK();
                
                await cos.putObject({
                    Bucket: 'your-bucket-name',
                    Region: 'your-region',
                    Key: `analytics/${key}.json`,
                    Body: JSON.stringify(data)
                });
                
                return true;
            } catch (error) {
                console.error('Error saving data to Tencent Cloud:', error);
                return false;
            }
        }
        */